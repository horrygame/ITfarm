<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Ферма</title>
    <style>
        :root {
            --primary: #4cc9f0;
            --secondary: #4361ee;
            --accent: #f72585;
            --dark: #1a2b3c;
            --light: #f8f9fa;
            --success: #4ade80;
            --warning: #facc15;
            --danger: #f87171;
            --common: #a0aec0;
            --rare: #4299e1;
            --epic: #9f7aea;
            --legendary: #f6ad55;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 30, 0.7);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }
        
        h1 {
            margin: 0;
            font-size: 2.5rem;
            text-shadow: 0 0 10px rgba(76, 201, 240, 0.7);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--accent), #b5179e);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(247, 37, 133, 0.4);
        }
        
        .btn-logout {
            background: linear-gradient(135deg, #ff4757, #ff6b81);
        }
        
        .stats {
            display: flex;
            gap: 20px;
            background: rgba(0, 20, 40, 0.8);
            padding: 15px;
            border-radius: 15px;
            font-size: 1.2rem;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .farm {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .field {
            background: rgba(0, 40, 80, 0.7);
            border: 3px solid var(--primary);
            border-radius: 15px;
            height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .field:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(76, 201, 240, 0.3);
        }
        
        .field-content {
            font-size: 4rem;
            text-align: center;
            z-index: 2;
        }
        
        .field-info {
            position: absolute;
            bottom: 10px;
            font-size: 0.9rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 3px 10px;
            border-radius: 10px;
        }
        
        .growth-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 8px;
            background: var(--primary);
            width: 0%;
            transition: width 0.5s;
        }
        
        .inventory {
            background: rgba(0, 20, 40, 0.8);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .inventory h2 {
            margin-top: 0;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .inventory-items {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .inventory-item {
            background: rgba(76, 201, 240, 0.2);
            padding: 15px;
            border-radius: 10px;
            min-width: 140px;
            text-align: center;
        }
        
        .shop {
            background: rgba(0, 20, 40, 0.8);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .shop h2 {
            margin-top: 0;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .shop-section {
            margin-bottom: 30px;
        }
        
        .shop-section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .seed-packs {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .seed-pack {
            background: linear-gradient(135deg, #3a0ca3, var(--secondary));
            border-radius: 15px;
            padding: 20px;
            width: 250px;
            transition: all 0.3s;
            position: relative;
        }
        
        .seed-pack:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(76, 201, 240, 0.4);
        }
        
        .seed-pack h3 {
            margin-top: 0;
            color: var(--accent);
        }
        
        .seed-list {
            margin: 15px 0;
            min-height: 100px;
        }
        
        .seed-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .seed-price {
            text-align: center;
            font-size: 1.5rem;
            margin: 15px 0;
            font-weight: bold;
        }
        
        .rarity {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .common-rarity {
            background-color: var(--common);
        }
        
        .rare-rarity {
            background-color: var(--rare);
        }
        
        .epic-rarity {
            background-color: var(--epic);
        }
        
        .legendary-rarity {
            background-color: var(--legendary);
        }
        
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .auth-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            text-align: center;
        }
        
        .auth-logo {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--primary);
            text-shadow: 0 0 10px rgba(76, 201, 240, 0.7);
        }
        
        .auth-title {
            color: white;
            margin-bottom: 30px;
            font-weight: 500;
            font-size: 1.8rem;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group input {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }
        
        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .input-group input:focus {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 10px rgba(76, 201, 240, 0.5);
        }
        
        .auth-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .auth-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(76, 201, 240, 0.4);
        }
        
        .auth-links {
            margin-top: 25px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .auth-link {
            color: var(--primary);
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .auth-link:hover {
            text-decoration: underline;
        }
        
        .error {
            color: var(--danger);
            margin-top: 15px;
            font-size: 14px;
            padding: 10px;
            border-radius: 10px;
            background: rgba(248, 113, 113, 0.1);
        }
        
        .ready {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 201, 240, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(76, 201, 240, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 201, 240, 0); }
        }
        
        .empty-field {
            font-size: 3rem;
            opacity: 0.3;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: var(--dark);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 30px rgba(76, 201, 240, 0.5);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-title {
            margin-top: 0;
            color: var(--primary);
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        
        .seed-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .seed-option {
            background: rgba(76, 201, 240, 0.2);
            border: 2px solid var(--primary);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .seed-option:hover {
            transform: scale(1.05);
            background: rgba(76, 201, 240, 0.4);
        }
        
        .seed-emoji {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        
        .modal-btn {
            padding: 12px 30px;
            margin: 0 10px;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, var(--accent), #b5179e);
            color: white;
        }
        
        .modal-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(247, 37, 133, 0.4);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 40, 80, 0.9);
            border-left: 5px solid var(--primary);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: translateX(100%);
            transition: transform 0.5s ease-in-out;
            z-index: 1001;
            max-width: 350px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-content {
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .notification.success {
            border-left-color: var(--success);
        }
        
        .notification.error {
            border-left-color: var(--danger);
        }

        /* Новые стили для системы сохранения */
        .save-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .save-textarea {
            width: 100%;
            height: 150px;
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-family: monospace;
            resize: none;
        }
        
        /* Стили для достижений */
        .achievements-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .achievement-card {
            background: rgba(0, 30, 60, 0.8);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 2px solid var(--common);
            transition: all 0.3s;
        }
        
        .achievement-card.unlocked {
            border-color: var(--legendary);
            background: rgba(246, 173, 85, 0.2);
            box-shadow: 0 0 15px rgba(246, 173, 85, 0.5);
        }
        
        .achievement-emoji {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .achievement-title {
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: var(--primary);
        }
        
        .achievement-progress {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .achievement-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.5s;
        }
        
        .achievement-count {
            font-size: 0.9rem;
            color: var(--warning);
        }
        
        .medal {
            font-size: 2rem;
            position: absolute;
            top: 10px;
            left: 10px;
        }
        
        /* Покупка полей */
        .field-purchase {
            background: rgba(0, 40, 80, 0.7);
            border: 2px dashed var(--primary);
            border-radius: 15px;
            height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .field-purchase:hover {
            background: rgba(0, 60, 120, 0.7);
        }
        
        .field-purchase-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .field-purchase-price {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .farm {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .seed-packs {
                flex-direction: column;
            }
            
            .seed-pack {
                width: 100%;
            }
            
            .save-controls {
                flex-direction: column;
            }
            
            .achievements-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div id="auth-container" class="auth-container">
        <div class="auth-box">
            <div class="auth-logo">🚜</div>
            <h1 class="auth-title">IT Ферма</h1>
            
            <div id="auth-form">
                <div class="input-group">
                    <input type="text" id="username" placeholder="Имя пользователя" required>
                </div>
                
                <div class="input-group">
                    <input type="password" id="password" placeholder="Пароль" required>
                </div>
                
                <div class="input-group" id="confirm-password-group" style="display: none;">
                    <input type="password" id="confirm-password" placeholder="Подтвердите пароль" required>
                </div>
                
                <button id="auth-btn" class="auth-btn">Войти</button>
                
                <div id="auth-error" class="error" style="display: none;"></div>
                
                <div class="auth-links">
                    <span id="auth-toggle-text">Нет аккаунта?</span>
                    <a href="#" id="auth-toggle-link" class="auth-link">Зарегистрироваться</a>
                </div>
            </div>
        </div>
    </div>

    <div id="game-container" class="container" style="display: none;">
        <div class="user-header">
            <h1>🚜 IT Ферма</h1>
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">👨‍🌾</div>
                <div>
                    <div id="username-display"></div>
                    <div class="save-controls">
                        <button class="btn" onclick="showExportModal()">Экспорт</button>
                        <button class="btn" onclick="showAchievementsModal()">Достижения</button>
                        <button class="btn btn-logout" onclick="logout()">Выйти</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="stats">
            <div class="money">💰 Деньги: <span id="money">100</span></div>
            <div class="fields">🧺 Поля: <span id="field-count">4</span>/<span id="max-fields">12</span></div>
        </div>
        
        <div class="farm" id="fields-container">
            <!-- Поля будут здесь -->
        </div>
        
        <div class="inventory">
            <h2>📦 Инвентарь</h2>
            <div class="inventory-items" id="inventory-list">
                <!-- Инвентарь будет здесь -->
            </div>
        </div>
        
        <div class="shop">
            <h2>🏪 Магазин</h2>
            
            <div class="shop-section">
                <div class="shop-section-title">
                    <span>🌱 Семена</span>
                </div>
                <div class="seed-packs" id="seed-packs-container">
                    <!-- Пакеты семян будут здесь -->
                </div>
            </div>
            
            <div class="shop-section">
                <div class="shop-section-title">
                    <span>🧺 Новые поля</span>
                </div>
                <div class="field-purchase" id="field-purchase">
                    <div class="field-purchase-icon">➕</div>
                    <div>Купить поле</div>
                    <div class="field-purchase-price" id="field-price">1000 💰</div>
                </div>
            </div>
        </div>
    </div>

    <div id="plantModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Выберите семена для посадки</h2>
            <div class="seed-options" id="seed-options">
                <!-- Опции будут добавлены через JS -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-close" id="closeModal">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно экспорта -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Экспорт сохранения</h2>
            <p>Скопируйте этот код и сохраните его. Вы сможете использовать его для восстановления прогресса на другом устройстве.</p>
            <textarea id="exportData" class="save-textarea" readonly></textarea>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="copyExportData()">Копировать</button>
                <button class="modal-btn modal-close" onclick="closeExportModal()">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно достижений -->
    <div id="achievementsModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">🏆 Достижения</h2>
            <p>Соберите культуру 1 000 000 раз, чтобы получить золотую медаль!</p>
            <div class="achievements-container" id="achievements-container">
                <!-- Достижения будут здесь -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-close" onclick="closeAchievementsModal()">Закрыть</button>
            </div>
        </div>
    </div>

    <div id="seedNotification" class="notification">
        <div class="notification-content" id="notification-content"></div>
    </div>

    <script>
        // Конфигурация игры
        const PLANTS = {
            // Common
            "common_laptop": {
                "name": "Ноутбук",
                "growth_time": 15,
                "reward": 20,
                "seed": "common_laptop_seed",
                "rarity": "common"
            },
            "it_student": {
                "name": "IT ученик",
                "growth_time": 20,
                "reward": 25,
                "seed": "it_student_seed",
                "rarity": "common"
            },
            "led": {
                "name": "Светодиод",
                "growth_time": 10,
                "reward": 15,
                "seed": "led_seed",
                "rarity": "common"
            },
            
            // Rare
            "gaming_pc": {
                "name": "Игровой ПК",
                "growth_time": 30,
                "reward": 50,
                "seed": "gaming_pc_seed",
                "rarity": "rare"
            },
            "it_graduate": {
                "name": "IT выпускник",
                "growth_time": 35,
                "reward": 60,
                "seed": "it_graduate_seed",
                "rarity": "rare"
            },
            "printer": {
                "name": "Принтер",
                "growth_time": 25,
                "reward": 45,
                "seed": "printer_seed",
                "rarity": "rare"
            },
            "gear": {
                "name": "Шестеренка",
                "growth_time": 20,
                "reward": 40,
                "seed": "gear_seed",
                "rarity": "rare"
            },
            
            // Epic
            "powerful_pc": {
                "name": "Мощный ПК",
                "growth_time": 60,
                "reward": 150,
                "seed": "powerful_pc_seed",
                "rarity": "epic"
            },
            "junior_dev": {
                "name": "Джуниор",
                "growth_time": 70,
                "reward": 180,
                "seed": "junior_dev_seed",
                "rarity": "epic"
            },
            "sensor": {
                "name": "Датчик",
                "growth_time": 50,
                "reward": 120,
                "seed": "sensor_seed",
                "rarity": "epic"
            },
            
            // Legendary
            "weak_pc": {
                "name": "Слабый ПК",
                "growth_time": 90,
                "reward": 300,
                "seed": "weak_pc_seed",
                "rarity": "legendary"
            },
            "coffee": {
                "name": "Кофе",
                "growth_time": 120,
                "reward": 500,
                "seed": "coffee_seed",
                "rarity": "legendary"
            },
            "senior_dev": {
                "name": "Сеньор",
                "growth_time": 100,
                "reward": 400,
                "seed": "senior_dev_seed",
                "rarity": "legendary"
            }
        };

        const SEED_PACKS = [
            {
                "name": "Начинающий",
                "price": 50,
                "rarity": "common",
                "drops": {
                    "common_laptop": 0.5,
                    "it_student": 0.3,
                    "led": 0.2
                }
            },
            {
                "name": "Профессионал",
                "price": 200,
                "rarity": "rare",
                "drops": {
                    "gaming_pc": 0.4,
                    "it_graduate": 0.3,
                    "printer": 0.2,
                    "gear": 0.1
                }
            },
            {
                "name": "Эксперт",
                "price": 500,
                "rarity": "epic",
                "drops": {
                    "powerful_pc": 0.5,
                    "junior_dev": 0.3,
                    "sensor": 0.2
                }
            },
            {
                "name": "Легендарный",
                "price": 1500,
                "rarity": "legendary",
                "drops": {
                    "weak_pc": 0.4,
                    "coffee": 0.3,
                    "senior_dev": 0.3
                }
            },
            {
                "name": "Микс",
                "price": 800,
                "rarity": "mixed",
                "drops": {
                    "common_laptop": 0.2,
                    "it_student": 0.15,
                    "led": 0.15,
                    "gaming_pc": 0.15,
                    "it_graduate": 0.1,
                    "printer": 0.1,
                    "gear": 0.05,
                    "powerful_pc": 0.05,
                    "junior_dev": 0.03,
                    "sensor": 0.02,
                    "weak_pc": 0.01,
                    "coffee": 0.01,
                    "senior_dev": 0.01
                }
            }
        ];

        // Цена покупки новых полей
        const FIELD_PRICES = [1000, 2500, 5000, 10000, 20000, 50000, 100000, 200000];

        // Состояние игры
        let gameState = {
            username: "",
            money: 100,
            inventory: {
                "common_laptop_seed": 5,
                "it_student_seed": 3,
                "led_seed": 4
            },
            fields: Array(4).fill().map((_, i) => ({
                id: i + 1,
                type: null,
                planted_at: null,
                growth: 0,
                ready: false
            })),
            achievements: {},
            purchasedFields: 0, // Количество купленных полей
            isRegistered: false
        };

        // Инициализация достижений
        function initAchievements() {
            for (const plantKey in PLANTS) {
                if (!gameState.achievements[plantKey]) {
                    gameState.achievements[plantKey] = {
                        count: 0,
                        medalEarned: false
                    };
                }
            }
        }

        // DOM элементы
        const authContainer = document.getElementById('auth-container');
        const gameContainer = document.getElementById('game-container');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const confirmPasswordGroup = document.getElementById('confirm-password-group');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const authBtn = document.getElementById('auth-btn');
        const authError = document.getElementById('auth-error');
        const authToggleText = document.getElementById('auth-toggle-text');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const usernameDisplay = document.getElementById('username-display');
        const userAvatar = document.getElementById('user-avatar');
        const moneyEl = document.getElementById('money');
        const fieldCountEl = document.getElementById('field-count');
        const maxFieldsEl = document.getElementById('max-fields');
        const inventoryList = document.getElementById('inventory-list');
        const fieldsContainer = document.getElementById('fields-container');
        const seedPacksContainer = document.getElementById('seed-packs-container');
        const fieldPurchaseEl = document.getElementById('field-purchase');
        const fieldPriceEl = document.getElementById('field-price');
        const plantModal = document.getElementById('plantModal');
        const seedOptionsEl = document.getElementById('seed-options');
        const closeModalBtn = document.getElementById('closeModal');
        const seedNotification = document.getElementById('seedNotification');
        const notificationContent = document.getElementById('notification-content');
        const exportModal = document.getElementById('exportModal');
        const achievementsModal = document.getElementById('achievementsModal');
        const achievementsContainer = document.getElementById('achievements-container');
        const exportDataEl = document.getElementById('exportData');

        let currentFieldId = null;
        let isRegisterMode = false;
        let growthIntervals = {};

        // Инициализация игры
        function initGame() {
            // Проверяем сохраненное состояние
            const savedGame = localStorage.getItem('it_farm_game');
            if (savedGame) {
                try {
                    const parsed = JSON.parse(savedGame);
                    if (parsed.isRegistered) {
                        gameState = parsed;
                        initAchievements();
                        showGameInterface();
                        startGrowthIntervals();
                    }
                } catch (e) {
                    console.error('Ошибка загрузки игры:', e);
                    localStorage.removeItem('it_farm_game');
                }
            }
            
            setupEventListeners();
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
            authBtn.addEventListener('click', handleAuth);
            authToggleLink.addEventListener('click', toggleAuthMode);
            closeModalBtn.addEventListener('click', () => {
                plantModal.style.display = 'none';
            });
            
            plantModal.addEventListener('click', (e) => {
                if (e.target === plantModal) {
                    plantModal.style.display = 'none';
                }
            });
            
            // Закрытие модальных окон при клике вне контента
            document.addEventListener('click', (e) => {
                if (e.target === exportModal) closeExportModal();
                if (e.target === achievementsModal) closeAchievementsModal();
            });
            
            // Покупка поля
            fieldPurchaseEl.addEventListener('click', buyField);
        }

        // Переключение между входом и регистрацией
        function toggleAuthMode(e) {
            e.preventDefault();
            isRegisterMode = !isRegisterMode;
            
            if (isRegisterMode) {
                authBtn.textContent = 'Зарегистрироваться';
                authToggleText.textContent = 'Уже есть аккаунт?';
                authToggleLink.textContent = 'Войти';
                confirmPasswordGroup.style.display = 'block';
            } else {
                authBtn.textContent = 'Войти';
                authToggleText.textContent = 'Нет аккаунта?';
                authToggleLink.textContent = 'Зарегистрироваться';
                confirmPasswordGroup.style.display = 'none';
            }
            
            authError.style.display = 'none';
        }

        // Обработка аутентификации
        function handleAuth() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            const confirmPassword = confirmPasswordInput.value.trim();
            
            if (!username || !password) {
                showAuthError('Заполните все поля');
                return;
            }
            
            if (isRegisterMode) {
                if (password !== confirmPassword) {
                    showAuthError('Пароли не совпадают');
                    return;
                }
                
                if (password.length < 4) {
                    showAuthError('Пароль должен быть не менее 4 символов');
                    return;
                }
                
                if (username.length < 3) {
                    showAuthError('Имя пользователя должно быть не менее 3 символов');
                    return;
                }
                
                registerUser(username);
            } else {
                loginUser(username);
            }
        }

        // Показать ошибку аутентификации
        function showAuthError(message) {
            authError.textContent = message;
            authError.style.display = 'block';
        }

        // Регистрация пользователя
        function registerUser(username) {
            gameState.username = username;
            gameState.isRegistered = true;
            initAchievements();
            saveGameState();
            showGameInterface();
        }

        // Вход пользователя
        function loginUser(username) {
            const savedGame = localStorage.getItem('it_farm_game');
            
            if (savedGame) {
                try {
                    const parsed = JSON.parse(savedGame);
                    if (parsed.username === username && parsed.isRegistered) {
                        gameState = parsed;
                        initAchievements();
                        showGameInterface();
                        startGrowthIntervals();
                        return;
                    }
                } catch (e) {
                    console.error('Ошибка входа:', e);
                }
            }
            
            showAuthError('Пользователь не найден');
        }

        // Выход из системы
        function logout() {
            gameState.isRegistered = false;
            saveGameState();
            hideGameInterface();
        }

        // Показать игровой интерфейс
        function showGameInterface() {
            authContainer.style.display = 'none';
            gameContainer.style.display = 'block';
            usernameDisplay.textContent = gameState.username;
            userAvatar.textContent = gameState.username.substring(0, 2).toUpperCase();
            renderGame();
            startGrowthIntervals();
        }

        // Скрыть игровой интерфейс
        function hideGameInterface() {
            authContainer.style.display = 'flex';
            gameContainer.style.display = 'none';
            stopGrowthIntervals();
            
            // Сброс полей формы
            usernameInput.value = '';
            passwordInput.value = '';
            confirmPasswordInput.value = '';
            authError.style.display = 'none';
        }

        // Сохранить состояние игры
        function saveGameState() {
            localStorage.setItem('it_farm_game', JSON.stringify(gameState));
        }

        // Рендер игры
        function renderGame() {
            // Обновляем деньги
            moneyEl.textContent = gameState.money;
            
            // Обновляем информацию о полях
            const totalFields = gameState.fields.length;
            fieldCountEl.textContent = totalFields;
            maxFieldsEl.textContent = 12;
            
            // Обновляем цену следующего поля
            if (gameState.purchasedFields < FIELD_PRICES.length) {
                fieldPriceEl.textContent = `${FIELD_PRICES[gameState.purchasedFields]} 💰`;
            } else {
                fieldPurchaseEl.style.display = 'none';
            }
            
            // Рендерим инвентарь
            inventoryList.innerHTML = '';
            for (const [item, quantity] of Object.entries(gameState.inventory)) {
                const itemName = item.replace('_seed', '');
                const itemDisplay = PLANTS[itemName]?.name || itemName;
                
                const itemEl = document.createElement('div');
                itemEl.className = 'inventory-item';
                
                // Добавляем цвет редкости
                const rarity = PLANTS[itemName]?.rarity || 'common';
                itemEl.style.borderLeft = `5px solid var(--${rarity})`;
                
                itemEl.innerHTML = `
                    <div class="inventory-item-icon">${getPlantEmoji(itemName)}</div>
                    <div>${itemDisplay}</div>
                    <div><strong>${quantity} шт.</strong></div>
                `;
                inventoryList.appendChild(itemEl);
            }
            
            // Рендерим поля
            fieldsContainer.innerHTML = '';
            gameState.fields.forEach(field => {
                const fieldEl = document.createElement('div');
                fieldEl.className = 'field';
                if (field.ready) fieldEl.classList.add('ready');
                
                let content = '<div class="empty-field">🟫</div>';
                let info = 'Пустое поле';
                
                if (field.type) {
                    const plant = PLANTS[field.type];
                    content = `
                        <div class="field-content">
                            ${getPlantEmoji(field.type)}
                        </div>
                    `;
                    info = plant.name;
                    if (!field.ready) info += ` (${Math.round(field.growth)}%)`;
                    
                    // Добавляем цвет редкости
                    fieldEl.style.borderColor = `var(--${plant.rarity})`;
                }
                
                fieldEl.innerHTML = `
                    ${content}
                    <div class="field-info">${info}</div>
                    <div class="growth-bar" style="width: ${field.growth}%"></div>
                `;
                
                // Обработчики событий
                if (field.ready) {
                    fieldEl.onclick = () => harvestField(field.id);
                } else if (!field.type) {
                    fieldEl.onclick = () => openPlantMenu(field.id);
                }
                
                fieldsContainer.appendChild(fieldEl);
            });
            
            // Добавляем кнопку покупки поля, если есть доступные слоты
            if (gameState.fields.length < 12 && gameState.purchasedFields < FIELD_PRICES.length) {
                const fieldPurchase = document.createElement('div');
                fieldPurchase.className = 'field-purchase';
                fieldPurchase.innerHTML = `
                    <div class="field-purchase-icon">➕</div>
                    <div>Купить поле</div>
                    <div class="field-purchase-price">${FIELD_PRICES[gameState.purchasedFields]} 💰</div>
                `;
                fieldPurchase.onclick = buyField;
                fieldsContainer.appendChild(fieldPurchase);
            }
            
            // Рендерим магазин
            seedPacksContainer.innerHTML = '';
            SEED_PACKS.forEach((pack, index) => {
                const packEl = document.createElement('div');
                packEl.className = 'seed-pack';
                
                let seedsHTML = '';
                for (const [seed, chance] of Object.entries(pack.drops)) {
                    seedsHTML += `
                        <div class="seed-item">
                            <div>${getPlantEmoji(seed)} ${PLANTS[seed].name}</div>
                            <div>${Math.round(chance * 100)}%</div>
                        </div>
                    `;
                }
                
                // Добавляем бейдж редкости
                let rarityBadge = '';
                if (pack.rarity) {
                    rarityBadge = `<div class="rarity ${pack.rarity}-rarity">${pack.rarity}</div>`;
                }
                
                packEl.innerHTML = `
                    ${rarityBadge}
                    <h3>${pack.name}</h3>
                    <div class="seed-list">${seedsHTML}</div>
                    <div class="seed-price">${pack.price} 💰</div>
                    <button class="btn" data-pack="${index}">Купить</button>
                `;
                
                packEl.querySelector('button').onclick = () => buySeedPack(index);
                seedPacksContainer.appendChild(packEl);
            });
        }

        // Получить эмодзи для растения
        function getPlantEmoji(type) {
            const emojis = {
                // Common
                'common_laptop': '💻',
                'it_student': '👨‍🎓',
                'led': '💡',
                
                // Rare
                'gaming_pc': '🖥️',
                'it_graduate': '🎓',
                'printer': '🖨️',
                'gear': '⚙️',
                
                // Epic
                'powerful_pc': '💻🔥',
                'junior_dev': '👨‍💻',
                'sensor': '📡',
                
                // Legendary
                'weak_pc': '💻🪫',
                'coffee': '☕',
                'senior_dev': '👴‍💻'
            };
            return emojis[type] || '🌱';
        }

        // Открыть меню посадки
        function openPlantMenu(fieldId) {
            currentFieldId = fieldId;
            seedOptionsEl.innerHTML = '';

            // Получаем доступные семена (у которых количество > 0)
            const seedTypes = Object.entries(gameState.inventory)
                .filter(([item, quantity]) => item.endsWith('_seed') && quantity > 0)
                .map(([item]) => item.replace('_seed', ''));
            
            if (seedTypes.length === 0) {
                showNotification('Нет семян для посадки! Купите в магазине.', 'error');
                return;
            }
            
            // Сортируем по редкости
            seedTypes.sort((a, b) => {
                const rarityOrder = {common: 0, rare: 1, epic: 2, legendary: 3};
                return rarityOrder[PLANTS[b].rarity] - rarityOrder[PLANTS[a].rarity];
            });
            
            // Заполняем модальное окно
            seedTypes.forEach(seedType => {
                const seedOption = document.createElement('div');
                seedOption.className = 'seed-option';
                
                // Добавляем цвет редкости
                const rarity = PLANTS[seedType].rarity;
                seedOption.style.borderLeft = `5px solid var(--${rarity})`;
                
                seedOption.innerHTML = `
                    <div class="seed-emoji">${getPlantEmoji(seedType)}</div>
                    <div>${PLANTS[seedType].name}</div>
                    <small>${gameState.inventory[seedType + '_seed']} шт.</small>
                `;
                seedOption.addEventListener('click', () => plantSelectedSeed(seedType));
                seedOptionsEl.appendChild(seedOption);
            });
            
            // Показываем модальное окно
            plantModal.style.display = 'flex';
        }

        // Посадить выбранное семя
        function plantSelectedSeed(seedType) {
            if (currentFieldId === null) return;

            const seedItem = seedType + "_seed";
            
            // Проверяем наличие семян
            if (!gameState.inventory[seedItem] || gameState.inventory[seedItem] <= 0) {
                showNotification('Недостаточно семян!', 'error');
                return;
            }
            
            // Находим поле
            const field = gameState.fields.find(f => f.id === currentFieldId);
            if (!field) return;
            
            // Сажаем семя
            field.type = seedType;
            field.planted_at = Date.now();
            field.growth = 0;
            field.ready = false;
            
            // Уменьшаем количество семян
            gameState.inventory[seedItem]--;
            
            // Сохраняем состояние
            saveGameState();
            renderGame();
            
            // Закрываем модальное окно
            plantModal.style.display = 'none';
            
            // Запускаем рост
            startGrowthForField(field.id);
            
            showNotification(`Посажено: ${PLANTS[seedType].name}!`, 'success');
        }

        // Собрать урожай
        function harvestField(fieldId) {
            const field = gameState.fields.find(f => f.id === fieldId);
            if (!field || !field.type || !field.ready) return;
            
            const plant = PLANTS[field.type];
            if (!plant) return;
            
            // Получаем награду
            gameState.money += plant.reward;
            
            // Добавляем семена этого же растения (количество зависит от редкости)
            const seedItem = plant.seed;
            const baseSeedCount = {
                "common": 2,
                "rare": 1,
                "epic": 1,
                "legendary": 1
            };
            
            let seedCount = baseSeedCount[plant.rarity];
            // Шанс дополнительных семян для редких растений
            if (plant.rarity !== "common" && Math.random() > 0.7) {
                seedCount++;
            }
            
            if (!gameState.inventory[seedItem]) {
                gameState.inventory[seedItem] = 0;
            }
            gameState.inventory[seedItem] += seedCount;
            
            // Обновляем достижения
            if (!gameState.achievements[field.type]) {
                gameState.achievements[field.type] = {
                    count: 0,
                    medalEarned: false
                };
            }
            
            gameState.achievements[field.type].count++;
            
            // Проверяем, достигнута ли медаль
            if (gameState.achievements[field.type].count >= 1000000) {
                gameState.achievements[field.type].medalEarned = true;
            }
            
            // Сбрасываем поле
            field.type = null;
            field.planted_at = null;
            field.growth = 0;
            field.ready = false;
            
            // Сохраняем состояние
            saveGameState();
            renderGame();
            
            // Останавливаем интервал роста
            if (growthIntervals[fieldId]) {
                clearInterval(growthIntervals[fieldId]);
                delete growthIntervals[fieldId];
            }
            
            showNotification(
                `Урожай собран: ${plant.name}!<br>+${plant.reward} 💰<br>Получено ${seedCount} семян`,
                'success'
            );
        }

        // Купить пакет семян
        function buySeedPack(packIndex) {
            const pack = SEED_PACKS[packIndex];
            if (!pack) return;
            
            if (gameState.money < pack.price) {
                showNotification('Недостаточно денег!', 'error');
                return;
            }
            
            // Выбираем случайное семя
            const seeds = Object.keys(pack.drops);
            const weights = Object.values(pack.drops);
            const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
            
            let random = Math.random() * totalWeight;
            let seedType = '';
            
            for (let i = 0; i < seeds.length; i++) {
                random -= weights[i];
                if (random <= 0) {
                    seedType = seeds[i];
                    break;
                }
            }
            
            if (!seedType) return;
            
            const seedItem = seedType + "_seed";
            
            // Покупаем пакет
            gameState.money -= pack.price;
            
            // Добавляем семя
            if (!gameState.inventory[seedItem]) {
                gameState.inventory[seedItem] = 0;
            }
            gameState.inventory[seedItem]++;
            
            // Сохраняем состояние
            saveGameState();
            renderGame();
            
            showNotification(
                `Куплен пакет "${pack.name}"!<br>Вы получили: ${PLANTS[seedType].name}`,
                'success'
            );
        }

        // Купить новое поле
        function buyField() {
            // Проверяем, можно ли купить еще поле
            if (gameState.fields.length >= 12 || gameState.purchasedFields >= FIELD_PRICES.length) {
                showNotification('Достигнуто максимальное количество полей!', 'error');
                return;
            }
            
            const price = FIELD_PRICES[gameState.purchasedFields];
            
            if (gameState.money < price) {
                showNotification('Недостаточно денег!', 'error');
                return;
            }
            
            // Покупаем поле
            gameState.money -= price;
            gameState.purchasedFields++;
            
            // Добавляем новое поле
            const newField = {
                id: gameState.fields.length + 1,
                type: null,
                planted_at: null,
                growth: 0,
                ready: false
            };
            
            gameState.fields.push(newField);
            
            // Сохраняем состояние
            saveGameState();
            renderGame();
            
            showNotification(
                `Куплено новое поле!<br>Теперь у вас ${gameState.fields.length} полей`,
                'success'
            );
        }

        // Запустить интервалы роста
        function startGrowthIntervals() {
            gameState.fields.forEach(field => {
                if (field.type && !field.ready) {
                    startGrowthForField(field.id);
                }
            });
        }

        // Остановить интервалы роста
        function stopGrowthIntervals() {
            Object.values(growthIntervals).forEach(interval => clearInterval(interval));
            growthIntervals = {};
        }

        // Запустить рост для конкретного поля
        function startGrowthForField(fieldId) {
            const field = gameState.fields.find(f => f.id === fieldId);
            if (!field || !field.type || field.ready) return;
            
            if (growthIntervals[fieldId]) {
                clearInterval(growthIntervals[fieldId]);
            }
            
            const plant = PLANTS[field.type];
            if (!plant) return;
            
            const growthTime = plant.growth_time * 1000; // в миллисекундах
            
            // Рассчитываем текущий прогресс
            const now = Date.now();
            const elapsed = now - field.planted_at;
            const progress = Math.min(100, (elapsed / growthTime) * 100);
            
            field.growth = progress;
            field.ready = progress >= 100;
            
            // Если уже готово, не запускаем интервал
            if (field.ready) {
                renderGame();
                return;
            }
            
            // Запускаем интервал обновления роста
            growthIntervals[fieldId] = setInterval(() => {
                const field = gameState.fields.find(f => f.id === fieldId);
                if (!field || !field.type) {
                    clearInterval(growthIntervals[fieldId]);
                    delete growthIntervals[fieldId];
                    return;
                }
                
                const now = Date.now();
                const elapsed = now - field.planted_at;
                const progress = Math.min(100, (elapsed / growthTime) * 100);
                
                field.growth = progress;
                field.ready = progress >= 100;
                
                // Обновляем отображение
                renderGame();
                
                // Если достигли 100%, останавливаем интервал
                if (field.ready) {
                    clearInterval(growthIntervals[fieldId]);
                    delete growthIntervals[fieldId];
                }
            }, 1000);
        }

        // Показать уведомление
        function showNotification(message, type = 'success') {
            notificationContent.innerHTML = message;
            seedNotification.className = `notification ${type}`;
            seedNotification.classList.add('show');
            
            setTimeout(() => {
                seedNotification.classList.remove('show');
            }, 3000);
        }

        // ====================
        // Система достижений
        // ====================
        
        // Показать модальное окно достижений
        function showAchievementsModal() {
            achievementsContainer.innerHTML = '';
            
            for (const plantKey in PLANTS) {
                const plant = PLANTS[plantKey];
                const achievement = gameState.achievements[plantKey] || {
                    count: 0,
                    medalEarned: false
                };
                
                const progress = Math.min(100, (achievement.count / 1000000) * 100);
                
                const achievementCard = document.createElement('div');
                achievementCard.className = `achievement-card ${achievement.medalEarned ? 'unlocked' : ''}`;
                
                achievementCard.innerHTML = `
                    ${achievement.medalEarned ? '<div class="medal">🏅</div>' : ''}
                    <div class="achievement-emoji">${getPlantEmoji(plantKey)}</div>
                    <div class="achievement-title">${plant.name}</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-bar" style="width: ${progress}%"></div>
                    </div>
                    <div class="achievement-count">${achievement.count.toLocaleString()}/1,000,000</div>
                `;
                
                achievementsContainer.appendChild(achievementCard);
            }
            
            achievementsModal.style.display = 'flex';
        }
        
        // Закрыть модальное окно достижений
        function closeAchievementsModal() {
            achievementsModal.style.display = 'none';
        }

        // ====================
        // Система сохранения
        // ====================
        
        // Показать модальное окно экспорта
        function showExportModal() {
            // Генерируем код сохранения
            const saveData = generateSaveCode();
            exportDataEl.value = saveData;
            exportModal.style.display = 'flex';
        }
        
        // Закрыть модальное окно экспорта
        function closeExportModal() {
            exportModal.style.display = 'none';
        }
        
        // Сгенерировать код сохранения
        function generateSaveCode() {
            const saveData = {
                version: 2, // Увеличиваем версию из-за изменений в структуре
                state: gameState
            };
            return btoa(encodeURIComponent(JSON.stringify(saveData)));
        }
        
        // Скопировать код сохранения в буфер обмена
        function copyExportData() {
            exportDataEl.select();
            document.execCommand('copy');
            showNotification('Код сохранения скопирован!', 'success');
        }

        // Инициализация при загрузке
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Производство</title>
    <style>
        :root {
            --primary: #4cc9f0;
            --secondary: #4361ee;
            --accent: #f72585;
            --dark: #1a2b3c;
            --light: #f8f9fa;
            --success: #4ade80;
            --warning: #facc15;
            --danger: #f87171;
            --factory: #f59e0b;
            --school: #3b82f6;
            --assembly: #10b981;
            --market: #a78bfa;
            --reset: #ef4444;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2c3e50, #1a2a6c);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 30, 0.8);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }
        
        h1 {
            margin: 0;
            font-size: 2.5rem;
            text-shadow: 0 0 10px rgba(76, 201, 240, 0.7);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--accent), #b5179e);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(247, 37, 133, 0.4);
        }
        
        .btn-reset {
            background: linear-gradient(135deg, var(--reset), #b91c1c);
        }
        
        .stats {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            background: rgba(0, 20, 40, 0.8);
            padding: 15px;
            border-radius: 15px;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        
        .resource {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 12px 25px;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 1.1rem;
            flex: 1;
            min-width: 120px;
            text-align: center;
        }
        
        .tab-btn.active {
            box-shadow: 0 0 15px rgba(76, 201, 240, 0.5);
        }
        
        .factory-btn.active {
            background: linear-gradient(135deg, var(--factory), #d97706);
        }
        
        .school-btn.active {
            background: linear-gradient(135deg, var(--school), #1d4ed8);
        }
        
        .assembly-btn.active {
            background: linear-gradient(135deg, var(--assembly), #047857);
        }
        
        .market-btn.active {
            background: linear-gradient(135deg, var(--market), #7e22ce);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .location-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid;
        }
        
        .factory .location-header {
            border-color: var(--factory);
        }
        
        .school .location-header {
            border-color: var(--school);
        }
        
        .assembly .location-header {
            border-color: var(--assembly);
        }
        
        .market .location-header {
            border-color: var(--market);
        }
        
        .location-title {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .location-description {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .buildings {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .building-card {
            background: rgba(0, 30, 60, 0.7);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .factory .building-card {
            border-color: var(--factory);
        }
        
        .school .building-card {
            border-color: var(--school);
        }
        
        .assembly .building-card {
            border-color: var(--assembly);
        }
        
        .building-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(76, 201, 240, 0.3);
        }
        
        .building-icon {
            font-size: 3.5rem;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .building-title {
            font-size: 1.4rem;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .building-info {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            font-size: 0.95rem;
        }
        
        .building-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        .building-count {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary);
        }
        
        .building-cost {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 15px;
            padding: 8px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            justify-content: center;
        }
        
        .building-requirements {
            margin: 15px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        .requirement-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }
        
        .building-actions {
            display: flex;
            gap: 10px;
        }
        
        .building-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .buy-btn {
            background: linear-gradient(135deg, var(--success), #16a34a);
            color: white;
        }
        
        .produce-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .building-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .building-btn:hover:not(:disabled) {
            transform: translateY(-3px);
        }
        
        .market-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .market-item {
            background: rgba(0, 30, 60, 0.7);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid var(--market);
            transition: all 0.3s;
        }
        
        .market-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(167, 139, 250, 0.3);
        }
        
        .market-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .market-title {
            font-size: 1.4rem;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .market-price {
            text-align: center;
            font-size: 1.5rem;
            margin: 15px 0;
            font-weight: bold;
            color: var(--success);
        }
        
        .price-trend {
            display: flex;
            justify-content: center;
            gap: 5px;
            font-size: 1.2rem;
        }
        
        .trend-up {
            color: var(--success);
        }
        
        .trend-down {
            color: var(--danger);
        }
        
        .trend-stable {
            color: var(--warning);
        }
        
        .market-quantity {
            text-align: center;
            margin: 10px 0;
            font-size: 1.1rem;
        }
        
        .market-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .sell-btn {
            background: linear-gradient(135deg, var(--success), #16a34a);
            color: white;
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .sell-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(22, 163, 74, 0.4);
        }
        
        .sell-all-btn {
            background: linear-gradient(135deg, var(--warning), #ca8a04);
            color: white;
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .sell-all-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(202, 138, 4, 0.4);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 40, 80, 0.9);
            border-left: 5px solid var(--primary);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: translateX(100%);
            transition: transform 0.5s ease-in-out;
            z-index: 1001;
            max-width: 350px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-content {
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .notification.success {
            border-left-color: var(--success);
        }
        
        .notification.error {
            border-left-color: var(--danger);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: var(--dark);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 30px rgba(76, 201, 240, 0.5);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-title {
            margin-top: 0;
            color: var(--primary);
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        
        .save-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .save-textarea {
            width: 100%;
            height: 150px;
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-family: monospace;
            resize: none;
        }
        
        .achievements-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .achievement-card {
            background: rgba(0, 30, 60, 0.8);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 2px solid var(--success);
            transition: all 0.3s;
        }
        
        .achievement-card.unlocked {
            border-color: var(--warning);
            background: rgba(246, 173, 85, 0.2);
            box-shadow: 0 0 15px rgba(246, 173, 85, 0.5);
        }
        
        .achievement-emoji {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .achievement-title {
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: var(--primary);
        }
        
        .achievement-progress {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .achievement-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.5s;
        }
        
        .achievement-count {
            font-size: 0.9rem;
            color: var(--warning);
        }
        
        .medal {
            font-size: 2rem;
            position: absolute;
            top: 10px;
            left: 10px;
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .buildings, .market-items {
                grid-template-columns: 1fr;
            }
            
            .user-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .user-info {
                justify-content: center;
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="user-header">
            <h1>🏭 IT Производство</h1>
            <div class="user-info">
                <div class="user-avatar">👨‍💼</div>
                <div class="save-controls">
                    <button class="btn" onclick="showAchievementsModal()">🏆 Достижения</button>
                    <button class="btn" onclick="showExportModal()">💾 Экспорт</button>
                    <button class="btn" onclick="showImportModal()">📥 Импорт</button>
                    <button class="btn btn-reset" onclick="resetProgress()">🔄 Сбросить</button>
                </div>
            </div>
        </div>
        
        <div class="stats" id="resources-panel">
            <!-- Ресурсы будут добавлены через JS -->
        </div>
        
        <div class="tabs">
            <button class="tab-btn factory-btn active" data-tab="factory">🏭 Завод</button>
            <button class="tab-btn school-btn" data-tab="school">🏫 Училище</button>
            <button class="tab-btn assembly-btn" data-tab="assembly">🔧 Сборка</button>
            <button class="tab-btn market-btn" data-tab="market">🏪 Рынок</button>
        </div>
        
        <!-- Локация: Завод -->
        <div id="factory" class="tab-content active factory">
            <div class="location-header">
                <div class="location-icon">🏭</div>
                <div class="location-title">Завод</div>
            </div>
            <div class="location-description">
                Здесь вы производите детали для сборки IT-продуктов. Покупайте станки для производства шестеренок, светодиодов, микросхем и датчиков.
            </div>
            <div class="buildings" id="factory-buildings">
                <!-- Карточки станков будут добавлены через JS -->
            </div>
        </div>
        
        <!-- Локация: Училище -->
        <div id="school" class="tab-content school">
            <div class="location-header">
                <div class="location-icon">🏫</div>
                <div class="location-title">Училище</div>
            </div>
            <div class="location-description">
                Обучайте IT-специалистов: учеников, выпускников, джуниоров и сеньоров. Они необходимы для сборки сложных продуктов.
            </div>
            <div class="buildings" id="school-buildings">
                <!-- Карточки зданий будут добавлены через JS -->
            </div>
        </div>
        
        <!-- Локация: Сборка -->
        <div id="assembly" class="tab-content assembly">
            <div class="location-header">
                <div class="location-icon">🔧</div>
                <div class="location-title">Сборка</div>
            </div>
            <div class="location-description">
                Используйте детали и специалистов для сборки IT-продуктов: ноутбуков, ПК, игровых систем и роботов.
            </div>
            <div class="buildings" id="assembly-buildings">
                <!-- Карточки филиалов будут добавлены через JS -->
            </div>
        </div>
        
        <!-- Локация: Рынок -->
        <div id="market" class="tab-content market">
            <div class="location-header">
                <div class="location-icon">🏪</div>
                <div class="location-title">Рынок</div>
            </div>
            <div class="location-description">
                Продавайте собранные IT-продукты на рынке. Цены постоянно меняются в зависимости от спроса и предложения. Продавайте в удачное время, чтобы получить максимальную прибыль!
            </div>
            <div class="market-items" id="market-items">
                <!-- Товары для продажи будут добавлены через JS -->
            </div>
        </div>
    </div>

    <!-- Модальное окно экспорта -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Экспорт сохранения</h2>
            <p>Скопируйте этот код и сохраните его. Вы сможете использовать его для восстановления прогресса на другом устройстве.</p>
            <textarea id="exportData" class="save-textarea" readonly></textarea>
            <div class="save-controls">
                <button class="btn" onclick="copyExportData()">Копировать</button>
                <button class="btn" onclick="closeExportModal()">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно импорта -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Импорт сохранения</h2>
            <p>Вставьте код сохранения в поле ниже:</p>
            <textarea id="importData" class="save-textarea" placeholder="Вставьте сюда код сохранения..."></textarea>
            <div class="save-controls">
                <button class="btn" onclick="loadGameData()">Загрузить</button>
                <button class="btn" onclick="closeImportModal()">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно достижений -->
    <div id="achievementsModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">🏆 Достижения</h2>
            <p>Выполняйте производственные задачи, чтобы получать достижения!</p>
            <div class="achievements-container" id="achievements-container">
                <!-- Достижения будут здесь -->
            </div>
            <div class="save-controls">
                <button class="btn" onclick="closeAchievementsModal()">Закрыть</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification">
        <div class="notification-content" id="notification-content"></div>
    </div>

    <script>
        // Конфигурация игры
        const RESOURCES = {
            money: { name: "Деньги", icon: "💰" },
            gears: { name: "Шестеренки", icon: "⚙️" },
            leds: { name: "Светодиоды", icon: "💡" },
            chips: { name: "Микросхемы", icon: "🔌" },
            sensors: { name: "Датчики", icon: "📡" },
            students: { name: "Ученики", icon: "👨‍🎓" },
            graduates: { name: "Выпускники", icon: "🎓" },
            juniors: { name: "Джуниоры", icon: "👨‍💻" },
            seniors: { name: "Сеньоры", icon: "👴‍💻" },
            laptops: { name: "Ноутбуки", icon: "💻" },
            powerful_laptops: { name: "Мощные ноутбуки", icon: "💻🔥" },
            pcs: { name: "ПК", icon: "🖥️" },
            gaming_pcs: { name: "Игровые ПК", icon: "🖥️🎮" },
            robots: { name: "Роботы", icon: "🤖" }
        };

        const BUILDINGS = {
            // Завод (производство деталей)
            factory: {
                gear_machine: {
                    name: "Станок шестеренок",
                    icon: "⚙️",
                    description: "Производит шестеренки для механических частей",
                    cost: { money: 500 },
                    production: { gears: 1 },
                    time: 10 // секунд
                },
                led_machine: {
                    name: "Станок светодиодов",
                    icon: "💡",
                    description: "Производит светодиоды для подсветки",
                    cost: { money: 800 },
                    production: { leds: 1 },
                    time: 12
                },
                chip_machine: {
                    name: "Станок микросхем",
                    icon: "🔌",
                    description: "Производит микросхемы для электронных устройств",
                    cost: { money: 1200 },
                    production: { chips: 1 },
                    time: 15
                },
                sensor_machine: {
                    name: "Станок датчиков",
                    icon: "📡",
                    description: "Производит датчики для умных устройств",
                    cost: { money: 2000 },
                    production: { sensors: 1 },
                    time: 20
                }
            },
            
            // Училище (производство специалистов)
            school: {
                student_building: {
                    name: "Здание учеников",
                    icon: "👨‍🎓",
                    description: "Обучает новых IT-учеников",
                    cost: { money: 1500 },
                    production: { students: 1 },
                    time: 15
                },
                graduate_building: {
                    name: "Здание выпускников",
                    icon: "🎓",
                    description: "Выпускает квалифицированных IT-специалистов",
                    cost: { money: 3000, students: 2 },
                    production: { graduates: 1 },
                    time: 20
                },
                junior_building: {
                    name: "Здание джуниоров",
                    icon: "👨‍💻",
                    description: "Готовит джуниор-разработчиков",
                    cost: { money: 6000, graduates: 3 },
                    production: { juniors: 1 },
                    time: 25
                },
                senior_building: {
                    name: "Здание сеньоров",
                    icon: "👴‍💻",
                    description: "Обучает опытных IT-сеньоров",
                    cost: { money: 12000, juniors: 2 },
                    production: { seniors: 1 },
                    time: 30
                }
            },
            
            // Сборка (производство продуктов)
            assembly: {
                laptop_branch: {
                    name: "Филиал ноутбуков",
                    icon: "💻",
                    description: "Собирает стандартные ноутбуки",
                    cost: { money: 5000 },
                    requirements: { gears: 3, leds: 2, chips: 4, students: 2 },
                    production: { laptops: 1 },
                    time: 20
                },
                powerful_laptop_branch: {
                    name: "Филиал мощных ноутбуков",
                    icon: "💻🔥",
                    description: "Собирает высокопроизводительные ноутбуки",
                    cost: { money: 10000 },
                    requirements: { gears: 5, leds: 3, chips: 8, graduates: 3 },
                    production: { powerful_laptops: 1 },
                    time: 30
                },
                pc_branch: {
                    name: "Филиал ПК",
                    icon: "🖥️",
                    description: "Собирает настольные компьютеры",
                    cost: { money: 15000 },
                    requirements: { gears: 8, leds: 4, chips: 10, juniors: 2 },
                    production: { pcs: 1 },
                    time: 40
                },
                gaming_pc_branch: {
                    name: "Филиал игровых ПК",
                    icon: "🖥️🎮",
                    description: "Собирает мощные игровые системы",
                    cost: { money: 25000 },
                    requirements: { gears: 12, leds: 6, chips: 15, sensors: 4, juniors: 4 },
                    production: { gaming_pcs: 1 },
                    time: 50
                },
                robot_branch: {
                    name: "Филиал роботов",
                    icon: "🤖",
                    description: "Собирает продвинутых IT-роботов",
                    cost: { money: 50000 },
                    requirements: { gears: 20, leds: 10, chips: 25, sensors: 10, seniors: 3 },
                    production: { robots: 1 },
                    time: 60
                }
            }
        };

        const MARKET_ITEMS = [
            { id: "laptops", name: "Ноутбук", icon: "💻", basePrice: 2500 },
            { id: "powerful_laptops", name: "Мощный ноутбук", icon: "💻🔥", basePrice: 6000 },
            { id: "pcs", name: "ПК", icon: "🖥️", basePrice: 10000 },
            { id: "gaming_pcs", name: "Игровой ПК", icon: "🖥️🎮", basePrice: 20000 },
            { id: "robots", name: "Робот", icon: "🤖", basePrice: 50000 }
        ];

        const ACHIEVEMENTS = [
            { id: "first_production", name: "Первое производство", description: "Произведите первую деталь", icon: "🏭", goal: 1 },
            { id: "student_graduate", name: "Первый выпускник", description: "Обучите первого выпускника", icon: "🎓", goal: 1 },
            { id: "laptop_production", name: "Ноутбук своими руками", description: "Соберите первый ноутбук", icon: "💻", goal: 1 },
            { id: "millionaire", name: "Миллионер", description: "Заработайте 1,000,000 денег", icon: "💰", goal: 1000000 },
            { id: "robot_master", name: "Мастер роботов", description: "Соберите 100 роботов", icon: "🤖", goal: 100 },
            { id: "market_king", name: "Король рынка", description: "Продайте товаров на 500,000", icon: "👑", goal: 500000 }
        ];

        // Начальное состояние игры
        const INITIAL_STATE = {
            resources: {
                money: 8000,
                gears: 0,
                leds: 0,
                chips: 0,
                sensors: 0,
                students: 0,
                graduates: 0,
                juniors: 0,
                seniors: 0,
                laptops: 0,
                powerful_laptops: 0,
                pcs: 0,
                gaming_pcs: 0,
                robots: 0
            },
            buildings: {
                // Завод
                gear_machine: { count: 0, progress: 0 },
                led_machine: { count: 0, progress: 0 },
                chip_machine: { count: 0, progress: 0 },
                sensor_machine: { count: 0, progress: 0 },
                
                // Училище
                student_building: { count: 0, progress: 0 },
                graduate_building: { count: 0, progress: 0 },
                junior_building: { count: 0, progress: 0 },
                senior_building: { count: 0, progress: 0 },
                
                // Сборка
                laptop_branch: { count: 0, progress: 0 },
                powerful_laptop_branch: { count: 0, progress: 0 },
                pc_branch: { count: 0, progress: 0 },
                gaming_pc_branch: { count: 0, progress: 0 },
                robot_branch: { count: 0, progress: 0 }
            },
            market: {
                laptops: { currentPrice: 2500, trend: 0 },
                powerful_laptops: { currentPrice: 6000, trend: 0 },
                pcs: { currentPrice: 10000, trend: 0 },
                gaming_pcs: { currentPrice: 20000, trend: 0 },
                robots: { currentPrice: 50000, trend: 0 }
            },
            achievements: {},
            lastUpdate: Date.now(),
            totalSales: 0
        };

        // Состояние игры
        let gameState = JSON.parse(JSON.stringify(INITIAL_STATE));

        // DOM элементы
        const resourcesPanel = document.getElementById('resources-panel');
        const factoryBuildings = document.getElementById('factory-buildings');
        const schoolBuildings = document.getElementById('school-buildings');
        const assemblyBuildings = document.getElementById('assembly-buildings');
        const marketItems = document.getElementById('market-items');
        const achievementsContainer = document.getElementById('achievements-container');
        const notification = document.getElementById('notification');
        const notificationContent = document.getElementById('notification-content');
        const exportModal = document.getElementById('exportModal');
        const importModal = document.getElementById('importModal');
        const achievementsModal = document.getElementById('achievementsModal');
        const exportDataEl = document.getElementById('exportData');
        const importDataEl = document.getElementById('importData');
        const tabButtons = document.querySelectorAll('.tab-btn');

        let productionInterval;
        let marketInterval;
        let achievementsEarned = false;

        // Инициализация игры
        function initGame() {
            // Проверяем сохраненное состояние
            const savedGame = localStorage.getItem('it_production_game');
            if (savedGame) {
                try {
                    const parsed = JSON.parse(savedGame);
                    gameState = parsed;
                    initAchievements();
                    renderGame();
                    startProduction();
                    startMarketFluctuations();
                } catch (e) {
                    console.error('Ошибка загрузки игры:', e);
                    localStorage.removeItem('it_production_game');
                    resetGameState();
                }
            } else {
                resetGameState();
            }
            
            setupEventListeners();
        }

        // Сброс состояния игры
        function resetGameState() {
            gameState = JSON.parse(JSON.stringify(INITIAL_STATE));
            initAchievements();
            renderGame();
            startProduction();
            startMarketFluctuations();
            saveGameState();
        }

        // Инициализация достижений
        function initAchievements() {
            ACHIEVEMENTS.forEach(achievement => {
                if (!gameState.achievements[achievement.id]) {
                    gameState.achievements[achievement.id] = {
                        progress: 0,
                        earned: false
                    };
                }
            });
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
            // Переключение вкладок
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    
                    // Скрыть все вкладки
                    document.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    
                    // Убрать активный класс у всех кнопок
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Показать выбранную вкладку
                    document.getElementById(tabId).classList.add('active');
                    button.classList.add('active');
                });
            });
            
            // Закрытие модальных окон при клике вне контента
            document.addEventListener('click', (e) => {
                if (e.target === exportModal) closeExportModal();
                if (e.target === importModal) closeImportModal();
                if (e.target === achievementsModal) closeAchievementsModal();
            });
        }

        // Рендер игры
        function renderGame() {
            renderResources();
            renderFactory();
            renderSchool();
            renderAssembly();
            renderMarket();
            checkAchievements();
        }

        // Отображение ресурсов
        function renderResources() {
            resourcesPanel.innerHTML = '';
            
            for (const [resourceKey, resource] of Object.entries(RESOURCES)) {
                const value = gameState.resources[resourceKey] || 0;
                const resourceEl = document.createElement('div');
                resourceEl.className = 'resource';
                resourceEl.innerHTML = `
                    <span>${resource.icon}</span>
                    <span>${resource.name}:</span>
                    <strong>${value.toLocaleString()}</strong>
                `;
                resourcesPanel.appendChild(resourceEl);
            }
        }

        // Отображение завода
        function renderFactory() {
            factoryBuildings.innerHTML = '';
            
            for (const [buildingKey, buildingConfig] of Object.entries(BUILDINGS.factory)) {
                const buildingState = gameState.buildings[buildingKey];
                const buildingEl = createBuildingCard(buildingConfig, buildingState, buildingKey, 'factory');
                factoryBuildings.appendChild(buildingEl);
            }
        }

        // Отображение училища
        function renderSchool() {
            schoolBuildings.innerHTML = '';
            
            for (const [buildingKey, buildingConfig] of Object.entries(BUILDINGS.school)) {
                const buildingState = gameState.buildings[buildingKey];
                const buildingEl = createBuildingCard(buildingConfig, buildingState, buildingKey, 'school');
                schoolBuildings.appendChild(buildingEl);
            }
        }

        // Отображение сборки
        function renderAssembly() {
            assemblyBuildings.innerHTML = '';
            
            for (const [buildingKey, buildingConfig] of Object.entries(BUILDINGS.assembly)) {
                const buildingState = gameState.buildings[buildingKey];
                const buildingEl = createBuildingCard(buildingConfig, buildingState, buildingKey, 'assembly');
                assemblyBuildings.appendChild(buildingEl);
            }
        }

        // Отображение рынка
        function renderMarket() {
            marketItems.innerHTML = '';
            
            MARKET_ITEMS.forEach(item => {
                const marketState = gameState.market[item.id];
                const quantity = gameState.resources[item.id] || 0;
                
                // Определение тренда цены
                let trendIcon = '➖';
                let trendClass = 'trend-stable';
                
                if (marketState.trend > 0) {
                    trendIcon = '📈';
                    trendClass = 'trend-up';
                } else if (marketState.trend < 0) {
                    trendIcon = '📉';
                    trendClass = 'trend-down';
                }
                
                const itemEl = document.createElement('div');
                itemEl.className = 'market-item';
                
                itemEl.innerHTML = `
                    <div class="market-icon">${item.icon}</div>
                    <div class="market-title">${item.name}</div>
                    <div class="market-price">${marketState.currentPrice.toLocaleString()} 💰</div>
                    <div class="price-trend ${trendClass}">${trendIcon} ${marketState.trend > 0 ? '+' : ''}${marketState.trend}%</div>
                    <div class="market-quantity">У вас: ${quantity.toLocaleString()} шт.</div>
                    <div class="market-actions">
                        <button class="sell-btn" onclick="sellProduct('${item.id}', 1)" ${quantity < 1 ? 'disabled' : ''}>
                            Продать 1
                        </button>
                        <button class="sell-all-btn" onclick="sellProduct('${item.id}', 'all')" ${quantity < 1 ? 'disabled' : ''}>
                            Продать все
                        </button>
                    </div>
                `;
                
                marketItems.appendChild(itemEl);
            });
        }

        // Создание карточки здания/станка/филиала
        function createBuildingCard(config, state, key, type) {
            const card = document.createElement('div');
            card.className = 'building-card';
            
            // Отображение прогресса производства
            const progressPercent = (state.progress / config.time) * 100;
            const progressBar = progressPercent > 0 ? 
                `<div class="progress-bar" style="height: 5px; background: var(--success); width: ${progressPercent}%; border-radius: 0 0 15px 15px; position: absolute; bottom: 0; left: 0;"></div>` : '';
            
            // Кнопки действий
            let buyButton = '';
            let produceButton = '';
            
            if (type === 'assembly') {
                if (state.count === 0) {
                    // Кнопка покупки для филиала сборки
                    const canBuy = canAfford(config.cost);
                    buyButton = `
                        <button class="building-btn buy-btn" ${!canBuy ? 'disabled' : ''}
                            onclick="buyBuilding('${key}')">
                            Купить (${formatCost(config.cost)})
                        </button>
                    `;
                } else {
                    // Кнопка производства для филиала сборки
                    const canProduce = canAfford(config.requirements);
                    produceButton = `
                        <button class="building-btn produce-btn" ${!canProduce ? 'disabled' : ''}
                            onclick="produceProduct('${key}')">
                            Произвести (${formatCost(config.requirements)})
                        </button>
                    `;
                }
            } else {
                // Кнопка покупки для завода и училища
                const canBuy = canAfford(config.cost);
                buyButton = `
                    <button class="building-btn buy-btn" ${!canBuy ? 'disabled' : ''}
                        onclick="buyBuilding('${key}')">
                        Купить (${formatCost(config.cost)})
                    </button>
                `;
            }
            
            // Требования для сборки
            let requirements = '';
            if (type === 'assembly') {
                requirements = `
                    <div class="building-requirements">
                        <strong>Требуется для производства:</strong>
                        ${Object.entries(config.requirements).map(([res, amount]) => `
                            <div class="requirement-item">
                                <span>${RESOURCES[res].icon} ${RESOURCES[res].name}</span>
                                <span>${amount}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            card.innerHTML = `
                <div class="building-icon">${config.icon}</div>
                <div class="building-title">${config.name}</div>
                <div class="building-info">${config.description}</div>
                
                <div class="building-stats">
                    <div>Количество:</div>
                    <div class="building-count">${state.count}</div>
                </div>
                
                ${type !== 'assembly' ? `
                <div class="building-stats">
                    <div>Производительность:</div>
                    <div>${formatProduction(config.production)} / ${config.time} сек</div>
                </div>
                ` : ''}
                
                ${requirements}
                
                <div class="building-actions">
                    ${buyButton}
                    ${produceButton}
                </div>
                ${progressBar}
            `;
            
            return card;
        }

        // Проверка, достаточно ли ресурсов
        function canAfford(cost) {
            for (const [resource, amount] of Object.entries(cost)) {
                if ((gameState.resources[resource] || 0) < amount) {
                    return false;
                }
            }
            return true;
        }

        // Форматирование стоимости
        function formatCost(cost) {
            return Object.entries(cost).map(([res, amount]) => 
                `${RESOURCES[res].icon} ${amount}`
            ).join(' + ');
        }

        // Форматирование производства
        function formatProduction(production) {
            return Object.entries(production).map(([res, amount]) => 
                `${RESOURCES[res].icon} ${amount}`
            ).join(' + ');
        }

        // Покупка здания/станка
        function buyBuilding(buildingKey) {
            let config;
            if (BUILDINGS.factory[buildingKey]) config = BUILDINGS.factory[buildingKey];
            else if (BUILDINGS.school[buildingKey]) config = BUILDINGS.school[buildingKey];
            else if (BUILDINGS.assembly[buildingKey]) config = BUILDINGS.assembly[buildingKey];
            
            if (!config || !canAfford(config.cost)) return;
            
            // Списываем стоимость
            for (const [resource, amount] of Object.entries(config.cost)) {
                gameState.resources[resource] = (gameState.resources[resource] || 0) - amount;
            }
            
            // Увеличиваем количество
            gameState.buildings[buildingKey].count++;
            
            // Обновляем интерфейс
            saveGameState();
            renderGame();
            
            showNotification(`Куплено: ${config.name}!`, 'success');
        }

        // Производство продукта (для сборки)
        function produceProduct(buildingKey) {
            const config = BUILDINGS.assembly[buildingKey];
            if (!config || !canAfford(config.requirements)) return;
            
            // Списываем стоимость
            for (const [resource, amount] of Object.entries(config.requirements)) {
                gameState.resources[resource] = (gameState.resources[resource] || 0) - amount;
            }
            
            // Устанавливаем прогресс производства
            gameState.buildings[buildingKey].progress = config.time;
            
            // Обновляем интерфейс
            saveGameState();
            renderGame();
            
            showNotification(`Начато производство: ${config.name}!`, 'success');
        }

        // Продажа товара на рынке
        function sellProduct(productId, amount) {
            const marketItem = gameState.market[productId];
            const currentQuantity = gameState.resources[productId] || 0;
            
            // Определяем количество для продажи
            let sellAmount = amount;
            if (amount === 'all') {
                sellAmount = currentQuantity;
            }
            
            // Проверяем, есть ли товар
            if (currentQuantity < sellAmount || sellAmount <= 0) {
                showNotification('Недостаточно товара для продажи!', 'error');
                return;
            }
            
            // Рассчитываем выручку
            const totalRevenue = Math.round(sellAmount * marketItem.currentPrice);
            
            // Уменьшаем количество товара
            gameState.resources[productId] -= sellAmount;
            
            // Увеличиваем деньги
            gameState.resources.money = (gameState.resources.money || 0) + totalRevenue;
            
            // Обновляем общий объем продаж
            gameState.totalSales += totalRevenue;
            
            // Обновляем достижение "Король рынка"
            updateAchievement('market_king', totalRevenue);
            
            // Обновляем интерфейс
            saveGameState();
            renderGame();
            
            showNotification(`Продано ${sellAmount} ${RESOURCES[productId].name} за ${totalRevenue.toLocaleString()} 💰!`, 'success');
        }

        // Запуск производства
        function startProduction() {
            if (productionInterval) clearInterval(productionInterval);
            
            productionInterval = setInterval(() => {
                const now = Date.now();
                const deltaTime = (now - gameState.lastUpdate) / 1000; // в секундах
                gameState.lastUpdate = now;
                
                // Производство на заводе
                for (const [key, config] of Object.entries(BUILDINGS.factory)) {
                    const state = gameState.buildings[key];
                    if (state.count > 0) {
                        state.progress += deltaTime;
                        
                        if (state.progress >= config.time) {
                            state.progress = 0;
                            
                            // Добавляем произведенные ресурсы
                            for (const [resource, amount] of Object.entries(config.production)) {
                                gameState.resources[resource] = (gameState.resources[resource] || 0) + amount * state.count;
                            }
                        }
                    }
                }
                
                // Производство в училище
                for (const [key, config] of Object.entries(BUILDINGS.school)) {
                    const state = gameState.buildings[key];
                    if (state.count > 0) {
                        state.progress += deltaTime;
                        
                        if (state.progress >= config.time) {
                            state.progress = 0;
                            
                            // Добавляем произведенных специалистов
                            for (const [resource, amount] of Object.entries(config.production)) {
                                gameState.resources[resource] = (gameState.resources[resource] || 0) + amount * state.count;
                            }
                        }
                    }
                }
                
                // Производство на сборке
                for (const [key, config] of Object.entries(BUILDINGS.assembly)) {
                    const state = gameState.buildings[key];
                    if (state.progress > 0) {
                        state.progress -= deltaTime;
                        
                        if (state.progress <= 0) {
                            state.progress = 0;
                            
                            // Добавляем произведенный товар
                            for (const [resource, amount] of Object.entries(config.production)) {
                                gameState.resources[resource] = (gameState.resources[resource] || 0) + amount;
                            }
                            
                            // Обновляем достижения
                            if (key === 'laptop_branch') {
                                updateAchievement('laptop_production', 1);
                            } else if (key === 'robot_branch') {
                                updateAchievement('robot_master', 1);
                            }
                            
                            showNotification(`Произведен: ${config.name}!`, 'success');
                        }
                    }
                }
                
                // Обновляем достижение "Миллионер"
                if ((gameState.resources.money || 0) >= 1000000) {
                    updateAchievement('millionaire', 1000000);
                }
                
                saveGameState();
                renderGame();
            }, 1000);
        }

        // Запуск колебаний рынка
        function startMarketFluctuations() {
            if (marketInterval) clearInterval(marketInterval);
            
            marketInterval = setInterval(() => {
                // Обновляем цены на все товары
                MARKET_ITEMS.forEach(item => {
                    const marketState = gameState.market[item.id];
                    
                    // Генерируем случайное колебание от -10% до +15%
                    const fluctuation = (Math.random() * 25 - 10) / 100;
                    
                    // Рассчитываем новую цену
                    const newPrice = Math.round(marketState.currentPrice * (1 + fluctuation));
                    
                    // Устанавливаем новый тренд в процентах
                    marketState.trend = Math.round(fluctuation * 100);
                    
                    // Убеждаемся, что цена не опустится ниже 10% от базовой
                    marketState.currentPrice = Math.max(newPrice, item.basePrice * 0.1);
                });
                
                saveGameState();
                renderMarket();
            }, 30000); // Обновление каждые 30 секунд
        }

        // Проверка достижений
        function checkAchievements() {
            // Проверяем первое производство
            if ((gameState.resources.gears || 0) > 0 && !gameState.achievements.first_production.earned) {
                updateAchievement('first_production', 1);
            }
            
            // Проверяем первого выпускника
            if ((gameState.resources.graduates || 0) > 0 && !gameState.achievements.student_graduate.earned) {
                updateAchievement('student_graduate', 1);
            }
        }

        // Обновление достижения
        function updateAchievement(achievementId, progress) {
            const achievement = gameState.achievements[achievementId];
            if (!achievement) return;
            
            achievement.progress += progress;
            
            const achievementConfig = ACHIEVEMENTS.find(a => a.id === achievementId);
            if (!achievementConfig) return;
            
            if (achievement.progress >= achievementConfig.goal && !achievement.earned) {
                achievement.earned = true;
                achievementsEarned = true;
                showNotification(`Достижение получено: ${achievementConfig.name}!`, 'success');
            }
        }

        // Показать достижения
        function showAchievements() {
            achievementsContainer.innerHTML = '';
            
            ACHIEVEMENTS.forEach(achievement => {
                const achievementState = gameState.achievements[achievement.id] || { progress: 0, earned: false };
                const progress = Math.min(100, (achievementState.progress / achievement.goal) * 100);
                
                const card = document.createElement('div');
                card.className = `achievement-card ${achievementState.earned ? 'unlocked' : ''}`;
                
                card.innerHTML = `
                    ${achievementState.earned ? '<div class="medal">🏅</div>' : ''}
                    <div class="achievement-emoji">${achievement.icon}</div>
                    <div class="achievement-title">${achievement.name}</div>
                    <div class="achievement-description">${achievement.description}</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-bar" style="width: ${progress}%"></div>
                    </div>
                    <div class="achievement-count">${achievementState.progress.toLocaleString()}/${achievement.goal.toLocaleString()}</div>
                `;
                
                achievementsContainer.appendChild(card);
            });
            
            achievementsModal.style.display = 'flex';
        }

        // Показать уведомление
        function showNotification(message, type = 'success') {
            notificationContent.innerHTML = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ====================
        // Система сохранения
        // ====================
        
        // Сохранить состояние игры
        function saveGameState() {
            localStorage.setItem('it_production_game', JSON.stringify(gameState));
        }
        
        // Показать модальное окно экспорта
        function showExportModal() {
            // Генерируем код сохранения
            const saveData = generateSaveCode();
            exportDataEl.value = saveData;
            exportModal.style.display = 'flex';
        }
        
        // Закрыть модальное окно экспорта
        function closeExportModal() {
            exportModal.style.display = 'none';
        }
        
        // Показать модальное окно импорта
        function showImportModal() {
            importDataEl.value = '';
            importModal.style.display = 'flex';
        }
        
        // Закрыть модальное окно импорта
        function closeImportModal() {
            importModal.style.display = 'none';
        }
        
        // Показать модальное окно достижений
        function showAchievementsModal() {
            showAchievements();
        }
        
        // Закрыть модальное окно достижений
        function closeAchievementsModal() {
            achievementsModal.style.display = 'none';
        }
        
        // Сгенерировать код сохранения
        function generateSaveCode() {
            const saveData = {
                version: 1,
                state: gameState
            };
            return btoa(encodeURIComponent(JSON.stringify(saveData)));
        }
        
        // Загрузить игру из кода
        function loadGameData() {
            const saveCode = importDataEl.value.trim();
            
            if (!saveCode) {
                showNotification('Введите код сохранения', 'error');
                return;
            }
            
            try {
                // Декодируем данные
                const decoded = JSON.parse(decodeURIComponent(atob(saveCode)));
                
                // Проверяем версию
                if (decoded.version !== 1) {
                    showNotification('Неверная версия сохранения', 'error');
                    return;
                }
                
                // Загружаем состояние
                gameState = decoded.state;
                
                // Сохраняем в localStorage
                saveGameState();
                
                // Перезагружаем интерфейс
                renderGame();
                
                // Перезапускаем интервалы
                startProduction();
                startMarketFluctuations();
                
                // Закрываем модальное окно
                closeImportModal();
                
                showNotification('Игра успешно загружена!', 'success');
            } catch (e) {
                console.error('Ошибка загрузки:', e);
                showNotification('Неверный формат сохранения', 'error');
            }
        }
        
        // Скопировать код сохранения в буфер обмена
        function copyExportData() {
            exportDataEl.select();
            document.execCommand('copy');
            showNotification('Код сохранения скопирован!', 'success');
        }
        
        // Сброс прогресса
        function resetProgress() {
            if (confirm("Вы уверены, что хотите сбросить весь прогресс? Это действие нельзя отменить.")) {
                resetGameState();
                showNotification('Прогресс успешно сброшен!', 'success');
            }
        }

        // Инициализация при загрузке
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
